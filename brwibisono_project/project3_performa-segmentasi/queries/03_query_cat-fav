-- brwibisono project 3
-- Kategori fav dalam komunitas segmen

WITH mxdate AS (
  SELECT
    DATE(MAX(o.created_at)) AS last_date
  FROM brbelajardata.thelook_copy.orders o
  WHERE o.status = 'Complete'
),

data_cust AS (
  SELECT
    u.id AS user_id,
    CONCAT(u.first_name, ' ', u.last_name) AS nama_cust,
    u.age AS usia_cust,
    CASE
      WHEN u.gender = 'M' THEN 'Laki-laki'
      WHEN u.gender = 'F' THEN 'Perempuan'
      ELSE 'Others'
    END AS jenis_kelamin
      --u.country AS negara_asal
  FROM brbelajardata.thelook_copy.users u
),

rfm_raw AS (
  SELECT
    o.user_id AS uid,
    DATE_DIFF(m.last_date, DATE(MAX(o.created_at)), DAY) AS recency,
    COUNT(DISTINCT o.order_id) AS frequency,
    ROUND(SUM(oi.sale_price), 2) AS monetary,
    NTILE(4) OVER (ORDER BY DATE_DIFF(m.last_date, DATE(MAX(oi.created_at)), DAY) ASC) AS r_score,
    NTILE(4) OVER (ORDER BY COUNT(DISTINCT o.order_id) DESC) AS f_score,
    NTILE(4) OVER (ORDER BY SUM(oi.sale_price) DESC) AS m_score
  FROM brbelajardata.thelook_copy.orders o
  JOIN brbelajardata.thelook_copy.order_items oi
    ON o.order_id = oi.order_id
  CROSS JOIN mxdate m
  WHERE o.status ='Complete'
    AND DATE (oi.created_at) BETWEEN '2024-01-01' AND m.last_date
  GROUP BY o.user_id, m.last_date
),

segmentasi AS (
  SELECT
    r.uid,
    CASE
      WHEN r.r_score = 4 AND r.f_score = 4 AND r.m_score = 4
        THEN 'Pelanggan Loyal'
      WHEN r.r_score >= 3 AND r.f_score >= 3
        THEN 'Potensial Loyal'
      WHEN r.r_score = 1 AND r.f_score = 1
        THEN 'Pelanggan Beresiko'
      WHEN r.r_score = 4 AND r.f_score = 1
        THEN 'Pelanggan Baru'
      ELSE 'Others'
    END AS segmen_pelanggan
  FROM rfm_raw r
),

loyal_cust AS (
  SELECT
    uid
  FROM segmentasi
  WHERE segmen_pelanggan = 'Pelanggan Loyal'
),

cat_loyal AS (
  SELECT 
    lc.uid,
    p.category,
    ROUND(SUM(oi.sale_price), 2) AS total_spending,
    ROW_NUMBER() OVER (PARTITION BY lc.uid ORDER BY SUM(oi.sale_price) DESC) AS rn
  FROM loyal_cust lc
  JOIN brbelajardata.thelook_copy.orders o
    ON lc.uid = o.user_id
  JOIN brbelajardata.thelook_copy.order_items oi
    ON o.user_id = oi.user_id
  JOIN brbelajardata.thelook_copy.products p
    ON oi.product_id = p.id
  WHERE o.status = 'Complete'
  GROUP BY lc.uid, p.category
)

SELECT
  dc.*,
  cl.category,
  cl.total_spending,
  cl.rn
FROM cat_loyal cl
JOIN data_cust dc
  ON dc.user_id = cl.uid
WHERE rn = 1
ORDER BY cl.total_spending DESC;
